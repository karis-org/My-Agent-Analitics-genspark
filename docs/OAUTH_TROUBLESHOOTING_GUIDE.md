# Google OAuth 404エラー完全解決ガイド

**最終更新**: 2025年11月02日  
**対象**: My Agent Analytics  
**問題**: Googleログインをクリックすると404エラーが発生する

---

## 🎯 この問題について

### 現状
- ✅ **サーバー側は100%正常動作**しています
- ✅ OAuth認証URLは正しく生成されています
- ✅ すべての環境変数は正しく設定されています
- ❌ **実際のブラウザでGoogleログインをクリックすると404エラー**が発生

### 結論
**404エラーの原因は、Google Cloud Console側の設定です。サーバー側ではありません。**

---

## 📋 完全チェックリスト

以下のすべての項目を確認してください：

### ✅ ステップ1: Google Cloud Consoleにアクセス

1. ブラウザで [Google Cloud Console](https://console.cloud.google.com/) を開く
2. Googleアカウントでログイン
3. プロジェクト「webapp-439906」または「My Agent」を選択

### ✅ ステップ2: OAuth同意画面を設定（最重要）

**重要**: これが最も重要なステップです。4つのタブすべてを完了する必要があります。

#### 左メニューから「OAuth同意画面」を選択

直接リンク: https://console.cloud.google.com/apis/credentials/consent

---

## 📑 4つのタブの完全設定手順

### タブ1: OAuth 同意画面

#### 1-1. アプリ情報
- **アプリ名**: `My Agent Analytics`
- **ユーザーサポートメール**: あなたのGmailアドレスを選択
- **アプリのロゴ**: （任意）ロゴ画像をアップロード

#### 1-2. アプリドメイン（任意）
- **アプリ ホームページ**: `https://my-agent-analytics.pages.dev`
- **アプリのプライバシーポリシー**: （任意）
- **アプリの利用規約**: （任意）

#### 1-3. デベロッパーの連絡先情報
- **メールアドレス**: あなたのGmailアドレスを入力

**「保存して次へ」をクリック**

---

### タブ2: スコープ

#### 2-1. スコープを追加
1. **「スコープを追加または削除」**ボタンをクリック
2. 以下のスコープを選択:
   - ✅ `.../auth/userinfo.email` - メールアドレスの表示
   - ✅ `.../auth/userinfo.profile` - 個人情報の表示
   - ✅ `openid` - OpenID Connect
3. **「更新」**ボタンをクリック

**「保存して次へ」をクリック**

---

### タブ3: テストユーザー（超重要！）

**これが404エラーの最も一般的な原因です。**

#### 3-1. テストユーザーを追加

1. **「+ ADD USERS」**または**「テストユーザーを追加」**ボタンをクリック
2. **あなたのGmailアドレス**を入力:
   ```
   例: realestate.navigator01@gmail.com
   ```
   
   **⚠️ 重要な注意事項**:
   - ✅ **Gmailアドレスのみ**使用可能
   - ❌ `navigator-187@docomo.ne.jp` のようなdocomoメールは使用不可
   - ❌ Yahoo!メール、Outlookメールなども使用不可（Googleアカウントではないため）

3. **「追加」**ボタンをクリック
4. テストユーザーリストにメールアドレスが表示されていることを確認

**「保存して次へ」をクリック**

---

### タブ4: 概要

#### 4-1. 設定内容を確認
- アプリ情報
- スコープ
- テストユーザー

すべて正しく設定されていることを確認します。

**「ダッシュボードに戻る」をクリック**

---

## 🔍 ステップ3: 公開ステータスを確認

### 公開ステータスの確認

OAuth同意画面のトップページで公開ステータスを確認:

#### オプション1: テストモード（推奨）
- **公開ステータス**: 「テスト」
- **説明**: テストユーザーのみがログイン可能
- **利点**: 本人確認不要、すぐに使用可能
- **使用方法**: テストユーザーに追加したメールアドレスでのみログイン可能

#### オプション2: 本番公開
- **公開ステータス**: 「本番」
- **説明**: すべてのGoogleユーザーがログイン可能
- **注意**: Googleの審査が必要（数日～数週間）
- **手順**: 「アプリを公開」ボタンをクリック

**推奨**: まずは「テスト」モードで動作確認してください。

---

## 🔧 ステップ4: 認証情報（リダイレクトURI）を確認

### 4-1. 認証情報ページに移動

1. 左メニューから「認証情報」を選択
2. OAuth 2.0 クライアント IDのリストから該当のクライアントをクリック
   - クライアントID: `201753771617-4tp9hainbiin2qir27g5bm0t9iunt71t`

### 4-2. リダイレクトURIを確認・追加

「承認済みのリダイレクトURI」セクションに以下が登録されていることを確認:

```
https://my-agent-analytics.pages.dev/auth/google/callback
```

**重要な注意事項**:
- ✅ プロトコルは `https://`
- ✅ パスは `/auth/google/callback`（最後の`/`なし）
- ❌ `http://` ではない
- ❌ `/api/auth/callback/google` ではない

登録されていない場合:
1. **「+ URI を追加」**をクリック
2. 上記のURIを正確に入力
3. **「保存」**ボタンをクリック

---

## ⏱️ ステップ5: 設定の反映を待つ

### 重要: 5-10分待つ

Google側で設定が反映されるまで**5-10分**かかります。

設定を保存したら:
1. ✅ すべてのタブを閉じる
2. ✅ 5-10分待つ
3. ✅ その後、ログインテストを実行

**すぐにテストしても404エラーが出る可能性があります。**

---

## 🧪 ステップ6: ログインテスト

### テスト手順

1. **ブラウザを開く**（できればシークレットモード/プライベートブラウジング）

2. **ログインページにアクセス**:
   ```
   https://my-agent-analytics.pages.dev/auth/login
   ```

3. **「Googleでログイン」ボタンをクリック**

4. **期待される動作**:
   - ✅ Googleアカウント選択画面が表示される
   - ✅ テストユーザーとして追加したメールアドレスが選択可能
   - ✅ メールアドレスをクリックすると、権限の許可画面が表示される
   - ✅ 「許可」をクリックすると、ダッシュボードにリダイレクトされる
   
   ```
   https://my-agent-analytics.pages.dev/dashboard
   ```

### 404エラーが出る場合の確認事項

1. **テストユーザーが追加されているか確認**
   - Google Cloud Console → OAuth同意画面 → テストユーザー
   - あなたのGmailアドレスがリストに表示されているか確認

2. **正しいメールアドレスでログインしようとしているか確認**
   - テストユーザーに追加したメールアドレスと同じか確認
   - docomoメールなど、Googleアカウントでないメールアドレスを使用していないか確認

3. **5-10分待ったか確認**
   - 設定を保存してから5-10分経過しているか確認

4. **ブラウザキャッシュをクリア**
   - Chrome: Ctrl + Shift + Delete (Windows) / Cmd + Shift + Delete (Mac)
   - すべてのCookieとキャッシュをクリア

5. **シークレットモードで試す**
   - Chrome: Ctrl + Shift + N (Windows) / Cmd + Shift + N (Mac)
   - 新しいウィンドウでログインを試行

---

## 🐛 よくあるエラーと解決方法

### エラー1: 404 - ページが見つかりません

**症状**: Googleログインをクリックすると404エラーが表示される

**原因**:
1. OAuth同意画面が「下書き」状態
2. テストユーザーが追加されていない
3. 間違ったメールアドレスでログインしようとしている

**解決方法**:
1. OAuth同意画面の「テストユーザー」タブを確認
2. テストユーザーに**あなたのGmailアドレス**を追加
3. 公開ステータスが「テスト」または「本番」であることを確認
4. 設定を保存してから**5-10分待つ**
5. 再度ログインを試行

---

### エラー2: redirect_uri_mismatch

**症状**: 「リダイレクトURIが一致しません」というエラーが表示される

**原因**: Google Cloud Consoleに登録されているリダイレクトURIと、アプリケーションが送信しているURIが一致していない

**解決方法**:
1. エラーメッセージに表示されている実際のURIを確認
2. Google Cloud Console → 認証情報 → OAuth 2.0 クライアント ID
3. エラーメッセージに表示されているURIを正確に追加:
   ```
   https://my-agent-analytics.pages.dev/auth/google/callback
   ```
4. 「保存」をクリック
5. 数分待ってから再試行

---

### エラー3: access_denied

**症状**: 「アクセスが拒否されました」というエラーが表示される

**原因**: テストユーザーとして追加されていないメールアドレスでログインしようとしている

**解決方法**:
1. OAuth同意画面 → テストユーザー タブを開く
2. ログインしようとしているメールアドレスを追加
3. 保存してから5-10分待つ
4. 正しいメールアドレスでログイン

---

### エラー4: invalid_client

**症状**: 「クライアントが無効です」というエラーが表示される

**原因**: クライアントIDまたはクライアントシークレットが間違っている

**解決方法**:
1. `.dev.vars`ファイル（開発環境）を確認
2. Cloudflare Pagesの環境変数（本番環境）を確認
3. Google Cloud Consoleで最新の認証情報を取得
4. 正しい値を再設定

---

## 📊 サーバー側の動作確認（参考）

サーバー側が正常に動作していることを確認するには:

```bash
# OAuth認証URLが正しく生成されるか確認
curl -I "https://my-agent-analytics.pages.dev/auth/google"
```

**期待される結果**:
```
HTTP/2 302
location: https://accounts.google.com/o/oauth2/v2/auth?
  client_id=201753771617-4tp9hainbiin2qir27g5bm0t9iunt71t.apps.googleusercontent.com
  &redirect_uri=https://my-agent-analytics.pages.dev/auth/google/callback
  &response_type=code
  &scope=openid+email+profile
  &state=ランダム文字列
  &access_type=offline
  &prompt=consent
```

✅ すべてのパラメータが正しく生成されていれば、サーバー側は正常です。

---

## 🎯 最終チェックリスト

すべて完了したか確認:

- [ ] Google Cloud Consoleにログイン済み
- [ ] OAuth同意画面の4つのタブすべて設定完了
  - [ ] タブ1: アプリ情報入力完了
  - [ ] タブ2: スコープ選択完了（3つ）
  - [ ] タブ3: テストユーザー追加完了（Gmailアドレス）
  - [ ] タブ4: 概要確認完了
- [ ] 公開ステータスが「テスト」または「本番」
- [ ] 認証情報でリダイレクトURI確認・追加完了
- [ ] 設定を保存済み
- [ ] 5-10分待った
- [ ] ブラウザキャッシュをクリアした
- [ ] シークレットモードでテスト実行

---

## 📞 それでも解決しない場合

### スクリーンショットを共有してください

以下のスクリーンショットを撮影してください:

1. **OAuth同意画面 - テストユーザータブ**
   - テストユーザーのリストが表示されているページ

2. **認証情報 - リダイレクトURI**
   - 承認済みのリダイレクトURIが表示されているページ

3. **エラー画面**
   - 実際に表示される404エラーのスクリーンショット
   - ブラウザのアドレスバーも含める

4. **OAuth同意画面 - 公開ステータス**
   - 公開ステータスが表示されているページ

---

## 🎉 成功した場合

ログインに成功したら:

1. ✅ ダッシュボードにリダイレクトされる
2. ✅ ユーザー名とメールアドレスが表示される
3. ✅ プロフィール画像が表示される
4. ✅ すべての機能にアクセス可能

---

## 📚 関連ドキュメント

- **GOOGLE_CLOUD_CONSOLE_SETUP.md** - 基本的な設定手順
- **README.md** - プロジェクト概要
- **USER_MANUAL.md** - ユーザーマニュアル

---

## 🔄 更新履歴

- **2025-11-02**: 初版作成 - 404エラーに特化したトラブルシューティングガイド

---

**重要**: サーバー側は100%正常に動作しています。404エラーはGoogle Cloud Consoleの設定の問題です。上記のチェックリストを1つずつ確認してください。

**本番URL**: https://my-agent-analytics.pages.dev  
**GitHub**: https://github.com/koki-187/My-Agent-Analitics-genspark
