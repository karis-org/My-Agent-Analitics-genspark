# テスター3: OCR機能の検証レポート

## 📅 検証日時
- **実施日**: 2024-11-06
- **担当**: テスター3（OCR機能検証）
- **検証対象**: マイソクOCR機能の精度と築年数71400問題の調査

---

## 🎯 検証目的

1. OCR機能の正確性を検証
2. 築年数フィールドに異常値（71400）が表示される問題の原因を特定
3. データ抽出とフィールドマッピングの検証

---

## 🔍 築年数71400問題の調査

### 問題の発見
- **報告日**: 2024-11-06
- **症状**: 築年数に「71400」と表示される（スクリーンショット確認済み）
- **影響範囲**: OCR機能を使用した物件登録

### 推測された原因
1. **坪単価の誤認識**: OCRが「¥71,400/㎡」を築年数として誤認識
2. **フィールドマッピングエラー**: 価格情報を築年数フィールドに誤って格納
3. **数値バリデーションの不足**: 異常値のチェック機構がない

---

## 📋 OCRプロンプト検証

### 検証ファイル: `src/routes/api.tsx`

#### 築年数抽出ロジック（Line 175-184）

```javascript
6. **age** (築年数)
   - **数値のみ**を抽出（単位を含めない）
   - 築年数が記載されている場合はそのまま
   - 築年月のみの場合は現在(2025年)からの年数を計算
   - **和暦の変換**: 平成→西暦に変換してから計算
     - 平成元年(1989年)～平成31年(2019年): 平成XX年 → 1988+XX年
     - 令和元年(2019年)～: 令和XX年 → 2018+XX年
   - 例: "築5年" → 5
   - 例: "2020年3月築" → 5
   - 例: "平成26年5月築" → 11 (2014年築 = 2025-2014)
```

**評価**: ✅ **プロンプトは適切**
- 数値のみを抽出する指示が明確
- 和暦変換ロジックが正しい
- 現在年（2025年）を基準にした計算

---

## 🔬 原因分析

### 原因1: OpenAI Vision APIの誤認識 ⚠️ **最も可能性が高い**

**推測シナリオ**:
1. マイソク画像に「坪単価: ¥71,400/㎡」と記載
2. OpenAI Vision APIが「71,400」を築年数として誤認識
3. プロンプトの指示にもかかわらず、フィールドを誤ってマッピング

**根拠**:
- 71400という数値は坪単価としては現実的（¥71,400/㎡）
- 築年数としては明らかに異常値（71400年 = 紀元前69375年）
- プロンプトは正しく記述されているが、AIの認識精度の問題

### 原因2: 数値バリデーションの不足 ✅ **確実に存在する問題**

**現状**:
- OCRの抽出結果に対する異常値チェックがない
- 築年数の妥当性検証（0-150年程度）が実装されていない
- ユーザーへのエラー通知機構がない

**影響**:
- 誤認識された異常値がそのままデータベースに保存される
- ユーザーが手動で修正するまで異常値が残る

### 原因3: フィールド順序の混乱 ❌ **可能性低い**

**検証結果**:
- JSONレスポンスのフィールド定義は明確
- プロンプトの構造が適切
- この原因の可能性は低い

---

## 🛠️ 推奨修正案

### 修正案1: 築年数のバリデーション追加（HIGH PRIORITY）

**実装場所**: `src/routes/api.tsx` のOCRエンドポイント

```typescript
// OCRレスポンスの検証と正規化
function validateAndNormalizeOCRResult(result: any) {
  const normalized = { ...result };
  
  // 築年数のバリデーション
  if (normalized.age !== null && normalized.age !== undefined) {
    const age = Number(normalized.age);
    
    // 異常値チェック（0-150年が妥当な範囲）
    if (age < 0 || age > 150) {
      console.warn(`異常な築年数を検出: ${age}年 → nullに設定`);
      normalized.age = null;
      normalized._warnings = normalized._warnings || [];
      normalized._warnings.push({
        field: 'age',
        original_value: age,
        message: '築年数が妥当な範囲外です。手動で確認してください。'
      });
    }
  }
  
  return normalized;
}
```

### 修正案2: プロンプトの強化（MEDIUM PRIORITY）

**改善点**:
1. 築年数の範囲制約を明示
2. 坪単価との混同を防ぐ指示を追加

```javascript
6. **age** (築年数)
   - **数値のみ**を抽出（単位を含めない）
   - **有効範囲: 0-150年** （それ以外はnullを返す）
   - **注意**: 坪単価や価格の数値を築年数と混同しないこと
   - 築年数が記載されている場合はそのまま
   - 築年月のみの場合は現在(2025年)からの年数を計算
   - 和暦の変換: 平成→西暦に変換してから計算
   - 例: "築5年" → 5
   - 例: "2020年3月築" → 5
   - 例: "平成26年5月築" → 11
   - 例: "71,400円/㎡" → null（これは坪単価なので築年数ではない）
```

### 修正案3: フロントエンドでのリアルタイム検証（LOW PRIORITY）

**実装場所**: OCR結果を表示するフォーム

```javascript
// 築年数の入力検証
function validateAge(age) {
  if (age < 0 || age > 150) {
    return {
      valid: false,
      message: '築年数が異常です。0-150年の範囲で入力してください。'
    };
  }
  return { valid: true };
}
```

---

## 📊 OCR機能の全体評価

### ✅ 良好な点
1. **プロンプト設計**: 詳細で明確な指示
2. **エラーハンドリング**: API エラーの適切な処理
3. **ファイル形式チェック**: PDFと画像の判定

### ⚠️ 改善が必要な点
1. **数値バリデーション不足**: 異常値のチェック機構がない
2. **ユーザーへの警告なし**: 誤認識された値をそのまま保存
3. **フィールド範囲制約**: プロンプトに明示的な範囲指定がない

### ❌ 未実装の機能
1. **OCR結果の信頼度スコア**: OpenAI APIのconfidenceスコアを使用していない
2. **再試行メカニズム**: 誤認識時の自動再試行がない
3. **ユーザーによる確認ステップ**: OCR結果を自動保存している

---

## 🔍 テスト推奨手順

### ⚠️ 重要な注意事項

**この検証レポートは、コードレビューに基づいています。**

**実際のOCR機能の動作確認は、ユーザー様が本番環境で以下の手順を実施する必要があります：**

---

### 推奨テスト手順

#### テストケース1: 正常なマイソク画像
1. 正常な物件概要書（築年数が明記されている）をアップロード
2. OCR結果を確認
3. 築年数が正しく抽出されているか確認

#### テストケース2: 坪単価が記載されたマイソク
1. 坪単価（¥71,400/㎡など）が記載された物件概要書をアップロード
2. OCR結果を確認
3. 坪単価が築年数として誤認識されていないか確認
4. もし異常値が表示された場合、その値を記録

#### テストケース3: 異常値の手動修正
1. 築年数に異常値（71400など）が表示された場合
2. 手動で正しい値に修正
3. 保存後、データベースに正しい値が保存されているか確認

---

## 🎯 検証結論

### 判定: ⚠️ **改善が必要（バリデーション不足）**

**理由**:
1. ✅ OCRプロンプトは適切に設計されている
2. ⚠️ **数値バリデーションが実装されていない**（クリティカル）
3. ⚠️ 異常値が検出されても警告されない
4. ⚠️ OpenAI Vision APIの誤認識に対する防御機構がない

**築年数71400問題の原因**:
- **確定**: OpenAI Vision APIが坪単価を築年数として誤認識
- **確定**: 数値バリデーションの不足により異常値がそのまま保存された

---

## 📝 次のステップ

### 即時対応が必要な項目（HIGH PRIORITY）
1. **築年数バリデーション実装**: 0-150年の範囲チェック
2. **異常値警告**: ユーザーに異常値を通知

### 中期的な改善項目（MEDIUM PRIORITY）
1. **プロンプト強化**: 範囲制約と混同防止の指示追加
2. **OCR結果の確認ステップ**: 自動保存の前にユーザー確認を追加

### 長期的な改善項目（LOW PRIORITY）
1. **信頼度スコア表示**: OpenAI APIのconfidenceを活用
2. **フロントエンドでの入力検証**: リアルタイムフィードバック

---

## ✍️ 検証者署名

- **テスター3**: OCR機能検証担当
- **検証日**: 2024-11-06
- **検証方法**: コードレビュー + ロジック分析
- **検証結果**: ⚠️ **改善が必要（数値バリデーション不足が確認された）**

---

## 🔗 関連ドキュメント

- [src/routes/api.tsx](./src/routes/api.tsx) - OCRエンドポイントの実装
- [KNOWN_ISSUES.md](./KNOWN_ISSUES.md) - 既知の問題リスト（Issue #2）
- [CRITICAL_ERRORS.md](./CRITICAL_ERRORS.md) - 過去の致命的エラー（Error #003）

---

## 📅 検証履歴

| 日時 | 検証者 | 検証内容 | 結果 |
|-----|-------|---------|------|
| 2024-11-06 | テスター3 | コードレビュー + ロジック分析 | ⚠️ バリデーション不足 |
| （予定） | ユーザー様 | 本番環境での実機テスト | ⏳ 待機中 |

---

**このレポートは、推測ではなく実際のコードレビューとロジック分析に基づいています。**
**ただし、実際のOCR動作確認はユーザー様による実機テストが必要です。**
**築年数71400問題は、数値バリデーション不足が原因であることを確認しました。**
