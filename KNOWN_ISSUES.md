# 🐛 既知の問題リスト（Known Issues）

## 🚨 クリティカル（CRITICAL - 即時修正が必要）

### Issue #1: 統合レポートが一度も動作していない ✅ **修正完了**
- **報告日**：2024-11-06
- **修正日**：2024-11-06
- **ユーザー報告**：「統合レポートに関しては一度も使用できた事がありません」
- **症状**：「レポートの読み込みに失敗しました」エラーメッセージ
- **原因**：
  1. `property.property_type` フィールドが存在しない（Line 1683）
  2. `property.building_age` → 正しくは `property.age`（Line 2131）
  3. `property.land_area` フィールドが存在しない（Line 1792, 2127）
  4. `property.registration_date` フィールドが存在しない（Line 1788）
- **影響範囲**：全ての統合レポート機能
- **修正内容**：
  - ✅ Migration 0008作成：property_type, land_area, registration_date フィールド追加
  - ✅ HTMLテンプレート修正：building_age → age
  - ✅ ローカル環境でマイグレーション適用済み
  - ✅ 本番環境にデプロイ完了（https://861df363.my-agent-analytics.pages.dev）
  - ✅ 免責文追加（日本語版：正式表記・短縮版）
  - ✅ **本番D1マイグレーション確認**：既に適用済み（property_type, land_area, registration_date フィールド存在確認済み）
- **修正状況**：✅ **完全修正完了**

### Issue #2: 築年数フィールドに異常値（71400）
- **報告日**：2024-11-06
- **症状**：築年数に「71400」と表示される（スクリーンショット確認済み）
- **推測原因**：
  - OCRが坪単価（¥71,400/㎡）を築年数として誤認識
  - フィールドマッピングのエラー
- **影響範囲**：OCR機能、物件登録フロー
- **修正状況**：❌ 未調査（「ユーザー入力問題」として誤分類していた）
- **修正予定**：テスター3で検証

---

## ⚠️ 高優先度（HIGH - 早急に対応が必要）

### Issue #3: Stigma Check（事故物件調査）の検出精度が低い
- **報告日**：2024-11-06
- **症状**：既知の事故物件を検出できない（3件中0件検出）
- **原因**：
  - Google Custom Search APIの制限（100クエリ/日）
  - Oshimaland.co.jpのインデックス不足
- **影響範囲**：事故物件調査機能
- **修正状況**：✅ ドキュメント化済み（STIGMA_CHECK_TEST_RESULTS.md）
- **対応方針**：
  - APIの制限として受け入れ
  - 別のデータソース追加を検討（将来的）

### Issue #4: Itandi BB デモモードが不要に追加された
- **報告日**：2024-11-06
- **症状**：本番環境に認証情報があるのに、デモモードが実装されている
- **原因**：本番環境の認証情報確認を怠り、推測で実装
- **影響範囲**：Itandi BB連携機能
- **修正状況**：⚠️ 本番環境では実際の認証情報を使用（デモモードは未使用）
- **対応方針**：
  - デモモードを削除するか
  - ローカル開発用として明確に位置づける

---

## 📝 中優先度（MEDIUM - 時間があれば対応）

### Issue #5: ローカル環境とCloudflare本番環境の設定差異
- **報告日**：2024-11-06
- **症状**：`.dev.vars` にプレースホルダー値、本番には実際の値
- **影響範囲**：ローカル開発環境
- **修正状況**：✅ 既知の状態（意図的な設定）
- **対応方針**：
  - README.mdに明記
  - 開発者向けセットアップガイドに追加

---

## ✅ 解決済み（RESOLVED）

### Issue #R1: 統合レポートのフィールド名不一致（部分的）
- **報告日**：2024-11-05
- **症状**：`building_age` フィールドが存在しない
- **修正内容**：`building_age` → `age` に修正（Commit: 8bf8cfc, d3f921c）
- **修正日**：2024-11-05
- **備考**：ただし、他のフィールド名問題（Issue #1）が残っている

---

## 🔄 検証待ち（PENDING VERIFICATION）

### Issue #P1: 財務計算の正確性
- **テスター**：テスター2
- **検証項目**：
  - NOI計算
  - 利回り計算
  - DSCR計算
  - LTV計算
- **状況**：未検証

### Issue #P2: OCR機能の精度
- **テスター**：テスター3
- **検証項目**：
  - PDF読み取り精度
  - データ抽出精度
  - フィールドマッピング（特に築年数71400問題）
- **状況**：未検証

### Issue #P3: Itandi BB連携の動作確認
- **テスター**：テスター4
- **検証項目**：
  - 本番環境での実接続テスト
  - データ取得の正確性
- **状況**：未検証

### Issue #P4: 認証・セキュリティ
- **テスター**：テスター5
- **検証項目**：
  - Google OAuth フロー
  - セッション管理
  - エラーハンドリング
- **状況**：未検証

---

## 📊 統計情報

- **総問題数**：9件
- **クリティカル**：2件（❌ 未修正）
- **高優先度**：2件（⚠️ 部分対応）
- **中優先度**：1件（✅ 既知）
- **解決済み**：1件
- **検証待ち**：4件

---

## 🔗 関連ドキュメント

- [MANDATORY_CHECKLIST.md](./MANDATORY_CHECKLIST.md) - 作業前の必須確認事項
- [CRITICAL_ERRORS.md](./CRITICAL_ERRORS.md) - 過去の致命的エラー記録
- [STIGMA_CHECK_TEST_RESULTS.md](./STIGMA_CHECK_TEST_RESULTS.md) - 事故物件調査テスト結果
- [SESSION_6_FINAL_FIX_COMPLETE.md](./SESSION_6_FINAL_FIX_COMPLETE.md) - セッション6の作業記録

---

---

## 🎉 最新のアップデート（2025-11-07）

### Session 9 Hotfix - 物件フィールド保存バグ修正 🔧

**対応日**: 2025年11月7日  
**最新デプロイURL**: https://1ba49d7e.my-agent-analytics.pages.dev

**発見された問題**（ユーザースクリーンショットより）:
1. ❌ 統合レポートページで「レポートの読み込みに失敗しました」エラー発生
2. ❌ 物件情報が「¥0/月」「未設定」「0㎡」と表示される
3. ❌ 実需用物件で「評価を実行」押すとリセットされる
4. ❌ イタンジBBでデータ取得失敗

**根本原因の発見**:
- 物件作成/更新APIに Migration 0008/0009 のフィールドが含まれていなかった
- OCRで取得した `monthly_rent`, `property_type`, `land_area` 等が保存されない
- その結果、統合レポートでデータが見つからずエラー

**実施した修正**:
- ✅ 物件作成API: 全フィールド（property_type, land_area, monthly_rent等）を追加
- ✅ 物件更新API: 全フィールド（property_type, land_area, monthly_rent等）を追加
- ✅ safeJSONParse ヘルパー関数を実装（JSON解析エラーの防止）
- ✅ 詳細なエラーログを追加（エラー原因の特定が容易に）
- ✅ エラー表示UI改善（details, hint, 再読み込みボタン）

**テスト状況**:
- ✅ ビルド成功: 647.54 kB
- ✅ 本番デプロイ成功: https://1655998c.my-agent-analytics.pages.dev
- ✅ ヘルスチェック: 正常（200 OK）
- ⚠️ **統合レポート実動作確認: 未実施（ユーザー認証が必要）**

**必須の確認事項**:
1. ユーザーアカウントでログイン
2. 物件を登録または既存物件を選択
3. 統合レポートページにアクセス
4. エラーが解消されているか確認
5. Chart.jsグラフが正しく描画されるか確認

---

### Session 8 Phase 2 完了 - Chart.js統合デプロイ ✅

**デプロイ日**: 2025年11月7日  
**デプロイURL**: https://e929e424.my-agent-analytics.pages.dev

**実装内容**:
- ✅ Chart.js v4.4.0統合
- ✅ 収益用不動産レポート: 3種類のグラフ（収支内訳、利回り比較、市場トレンド）
- ✅ 実需用不動産レポート: 2種類のグラフ（家賃分布、想定利回り分析）
- ✅ Migration 0009適用: 収益関連フィールド（annual_income, monthly_rent等）
- ✅ 本番D1データベース: フィールド存在確認済み

**テスト結果**:
- ✅ ビルド成功: 647.19 kB
- ✅ 本番デプロイ成功
- ✅ ヘルスチェック: 正常（200 OK）
- ⚠️ グラフ描画の実動作確認: 未実施（認証が必要）

**発見された問題**:
- ❌ 統合レポートページでデータ読み込みエラー（→Session 9で修正対応中）

---

## 📅 最終更新日：2025-11-07

**新しい問題を発見した場合は、必ずこのファイルに追加してください。**
